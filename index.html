<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campaign Component Builder ‚Äî Tryg</title>
  <style>
    /* =========================================================
       Brand Tokens (extracted from Figma MCP)
       ========================================================= */
    :root {
      --color-primary:  #ED1C24;
      --color-primary-dark: #D41920;
      --color-text:     #1A1A1A;
      --color-text-light: #666666;
      --color-bg:       #FFFFFF;
      --color-bg-alt:   #F5F5F5;
      --color-border:   #E0E0E0;
      --font-heading:   'Tryg Sans', Arial, sans-serif;
      --font-body:      Arial, sans-serif;
      --spacing-sm:     8px;
      --spacing-md:     16px;
      --spacing-lg:     32px;
      --spacing-xl:     64px;
      --radius:         24px;
      --radius-sm:      8px;
      --radius-card:    12px;
    }

    /* =========================================================
       Builder UI Styles
       ========================================================= */
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: Arial, sans-serif;
      background: #f5f6f8;
      color: #1a1a1a;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Top Bar */
    .builder-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--color-primary);
      color: #fff;
      padding: 0 20px;
      height: 56px;
      flex-shrink: 0;
    }
    .builder-topbar h1 {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    .builder-topbar .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .builder-topbar .component-count {
      background: rgba(255,255,255,0.15);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
    }

    /* Settings row */
    .builder-settings {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 10px 20px;
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
    }
    .builder-settings label {
      font-size: 13px;
      font-weight: 600;
      color: #555;
    }
    .builder-settings input[type="text"],
    .builder-settings select {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: var(--radius);
      font-size: 13px;
      background: #fff;
    }
    .builder-settings input[type="text"] {
      width: 240px;
    }
    .builder-settings select {
      width: 80px;
    }
    .builder-settings .reset-btn {
      margin-left: auto;
      padding: 6px 14px;
      border: 1px solid #ccc;
      border-radius: var(--radius);
      background: #fff;
      font-size: 13px;
      cursor: pointer;
      color: #555;
      transition: background 0.15s;
    }
    .builder-settings .reset-btn:hover {
      background: #f0f0f0;
    }

    /* Main Three-Panel Layout */
    .builder-main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Left Panel ‚Äî Library */
    .panel-library {
      width: 30%;
      min-width: 180px;
      background: #fff;
      border-right: 1px solid #e0e0e0;
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    .library-scroll-inner {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    /* Drag handle on the right edge of the library panel */
    .library-resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      cursor: col-resize;
      z-index: 10;
      transition: background 0.15s;
    }
    .library-resize-handle:hover,
    .library-resize-handle.is-dragging {
      background: var(--color-primary);
    }
    .panel-library h2 {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #888;
      margin-bottom: 12px;
    }
    .library-category {
      margin-bottom: 16px;
    }
    .library-category h3 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #aaa;
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid #f0f0f0;
    }
    .library-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px;
      border-radius: var(--radius-sm);
      transition: background 0.15s, border-color 0.15s;
      margin-bottom: 4px;
      border: 1.5px solid transparent;
    }
    .library-item:hover {
      background: #fafafa;
    }
    .library-item.previewing {
      background: #fff5f5;
      border-color: var(--color-primary);
    }
    .library-item input[type="checkbox"] {
      margin-top: 2px;
      accent-color: var(--color-primary);
      width: 16px;
      height: 16px;
      cursor: pointer;
      flex-shrink: 0;
    }
    .library-item-info {
      flex: 1;
      cursor: pointer;
    }
    .library-item-info .item-name {
      font-size: 14px;
      font-weight: 600;
      color: #1a1a1a;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .library-item-info .item-name .preview-icon {
      font-size: 12px;
      color: #bbb;
      transition: color 0.15s;
    }
    .library-item-info:hover .item-name .preview-icon {
      color: var(--color-primary);
    }
    .library-item.previewing .item-name .preview-icon {
      color: var(--color-primary);
    }
    .library-item-info .item-desc {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
      line-height: 1.4;
    }

    /* Centre Panel ‚Äî Canvas */
    .canvas-list {
      flex: 1;
      overflow-y: auto;
      padding: 0 20px 16px;
    }
    .canvas-empty {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #bbb;
      font-size: 14px;
      text-align: center;
      line-height: 1.6;
    }
    .canvas-card {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: var(--radius);
      padding: 12px 16px;
      margin-bottom: 8px;
      cursor: grab;
      transition: box-shadow 0.15s, border-color 0.15s;
      user-select: none;
    }
    .canvas-card:active {
      cursor: grabbing;
    }
    .canvas-card.drag-over {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(237, 28, 36, 0.15);
    }
    .canvas-card.dragging {
      opacity: 0.4;
    }
    .canvas-card .drag-handle {
      color: #ccc;
      font-size: 18px;
      line-height: 1;
      flex-shrink: 0;
    }
    .canvas-card .card-info {
      flex: 1;
    }
    .canvas-card .card-name {
      font-size: 14px;
      font-weight: 600;
    }
    .canvas-card .card-category {
      font-size: 11px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .canvas-card .card-remove {
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
      line-height: 1;
      border-radius: 50%;
      transition: color 0.15s, background 0.15s;
    }
    .canvas-card .card-remove:hover {
      color: var(--color-primary);
      background: rgba(237, 28, 36, 0.08);
    }

    .canvas-footer {
      padding: 12px 20px;
      border-top: 1px solid #e0e0e0;
      background: #fff;
    }
    .export-btn {
      display: block;
      width: 100%;
      padding: 12px;
      background: var(--color-primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    .export-btn:hover {
      background: var(--color-primary-dark);
    }
    .export-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Right Panel ‚Äî Preview */
    .panel-preview {
      width: 40%;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      background: #fff;
      border-left: 1px solid #e0e0e0;
      position: relative;
    }
    /* Drag handle on the left edge of the preview panel */
    .panel-resize-handle {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      cursor: col-resize;
      z-index: 10;
      transition: background 0.15s;
    }
    .panel-resize-handle:hover,
    .panel-resize-handle.is-dragging {
      background: var(--color-primary);
    }
    .preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      border-bottom: 1px solid #e0e0e0;
      gap: 8px;
    }
    .preview-header .preview-label {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #888;
      flex-shrink: 0;
    }
    .preview-header .preview-label .preview-component-name {
      color: var(--color-primary);
      font-weight: 600;
    }
    .preview-header-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .preview-scale-indicator {
      font-size: 11px;
      color: #aaa;
      background: #f0f0f0;
      padding: 2px 7px;
      border-radius: 10px;
      min-width: 38px;
      text-align: center;
      font-variant-numeric: tabular-nums;
    }
    .preview-toggles {
      display: flex;
      gap: 4px;
    }
    .preview-toggles button {
      padding: 4px 10px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      background: #fff;
      font-size: 12px;
      cursor: pointer;
      color: #666;
      transition: all 0.15s;
    }
    .preview-toggles button.active {
      background: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }
    .preview-frame-wrapper {
      flex: 1;
      overflow: hidden;
      display: flex;
      align-items: flex-start;
      justify-content: flex-start;
      background: #e8e8e8;
      padding: 16px;
      position: relative;
    }
    .preview-frame-wrapper iframe {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: var(--radius-sm);
      transform-origin: top left;
      flex-shrink: 0;
    }

    /* Library category collapsible */
    .library-category h3 {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }
    .library-category h3:hover {
      color: #888;
    }
    .library-category-toggle {
      font-size: 10px;
      color: #ccc;
      transition: transform 0.2s;
      display: inline-block;
    }
    .library-category.collapsed .library-category-toggle {
      transform: rotate(-90deg);
    }
    .library-category-items {
      overflow: hidden;
      transition: max-height 0.2s ease;
      max-height: 2000px;
    }
    .library-category.collapsed .library-category-items {
      max-height: 0;
    }

    /* Collapsible canvas panel */
    .canvas-collapse-btn {
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      font-size: 13px;
      padding: 2px 6px;
      border-radius: 4px;
      transition: color 0.15s, background 0.15s;
      line-height: 1;
    }
    .canvas-collapse-btn:hover {
      color: #666;
      background: #f0f0f0;
    }
    .canvas-header {
      padding: 16px 20px 8px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #888;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .panel-canvas {
      width: 30%;
      flex: none;
      display: flex;
      flex-direction: column;
      background: #f5f6f8;
      min-width: 0;
      transition: width 0.25s ease, min-width 0.25s ease;
    }
    .panel-canvas.collapsed {
      flex: 0;
      min-width: 48px;
      max-width: 48px;
      overflow: hidden;
    }
    .panel-canvas.collapsed .canvas-list,
    .panel-canvas.collapsed .canvas-footer,
    .panel-canvas.collapsed .canvas-header-label {
      display: none;
    }
    .canvas-collapsed-label {
      display: none;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #aaa;
      padding: 16px 0;
      margin: auto;
    }
    .panel-canvas.collapsed .canvas-collapsed-label {
      display: block;
    }
    .panel-canvas.collapsed .canvas-collapse-btn {
      transform: rotate(180deg);
    }

    /* =============================================================
       Edit & Export Modal
       ============================================================= */
    .edit-export-overlay {
      position: fixed;
      inset: 0;
      z-index: 9000;
      background: rgba(0,0,0,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }
    .edit-export-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }
    .edit-export-modal {
      width: 92vw;
      height: 92vh;
      background: #fff;
      border-radius: var(--radius-card);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 24px 80px rgba(0,0,0,0.25);
      transform: translateY(20px) scale(0.97);
      transition: transform 0.25s ease;
    }
    .edit-export-overlay.open .edit-export-modal {
      transform: translateY(0) scale(1);
    }
    .edit-export-toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
    }
    .edit-export-toolbar h2 {
      font-size: 15px;
      font-weight: 600;
      color: var(--color-text);
      flex: 1;
    }
    .edit-export-toolbar .toolbar-hint {
      font-size: 12px;
      color: #999;
    }
    .edit-export-close {
      background: none;
      border: 1px solid #ddd;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 18px;
      line-height: 1;
      cursor: pointer;
      color: #888;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s, color 0.15s;
    }
    .edit-export-close:hover {
      background: #f0f0f0;
      color: var(--color-primary);
    }
    .edit-export-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .edit-export-download-btn {
      padding: 8px 20px;
      background: var(--color-primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    .edit-export-download-btn:hover {
      background: var(--color-primary-dark);
    }
    .edit-export-viewport-toggles {
      display: flex;
      gap: 4px;
    }
    .edit-export-viewport-toggles button {
      padding: 4px 10px;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      background: #fff;
      font-size: 12px;
      cursor: pointer;
      color: #666;
      transition: all 0.15s;
    }
    .edit-export-viewport-toggles button.active {
      background: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }
    .edit-export-body {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
      background: #e8e8e8;
    }
    .edit-frame-wrapper {
      flex: 1;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      overflow: hidden;
      padding: 16px;
      position: relative;
    }
    .edit-frame-wrapper iframe {
      border: 1px solid #ccc;
      border-radius: var(--radius-sm);
      background: #fff;
      transform-origin: top center;
      flex-shrink: 0;
      transition: width 0.3s ease;
    }

    /* Icon picker panel */
    .icon-picker-panel {
      position: absolute;
      top: 0;
      right: 0;
      width: 260px;
      height: 100%;
      background: #fff;
      border-left: 1px solid #e0e0e0;
      box-shadow: -4px 0 16px rgba(0,0,0,0.08);
      z-index: 10;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.2s ease;
    }
    .icon-picker-panel.open {
      transform: translateX(0);
    }
    .icon-picker-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #e0e0e0;
    }
    .icon-picker-header h3 {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text);
    }
    .icon-picker-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #888;
      padding: 2px;
    }
    .icon-picker-close:hover { color: var(--color-primary); }
    .icon-picker-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      padding: 12px;
      overflow-y: auto;
      flex: 1;
    }
    .icon-picker-grid button {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e0e0e0;
      border-radius: var(--radius-sm);
      background: #fafafa;
      cursor: pointer;
      padding: 8px;
      transition: border-color 0.15s, background 0.15s;
    }
    .icon-picker-grid button:hover {
      border-color: var(--color-primary);
      background: #fff5f5;
    }
    .icon-picker-grid button svg {
      width: 24px;
      height: 24px;
    }

    /* Image editor panel */
    .image-editor-panel {
      position: absolute;
      top: 0;
      right: 0;
      width: 320px;
      height: 100%;
      background: #fff;
      border-left: 1px solid #e0e0e0;
      box-shadow: -4px 0 16px rgba(0,0,0,0.08);
      z-index: 10;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.2s ease;
    }
    .image-editor-panel.open {
      transform: translateX(0);
    }
    .image-editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid #e0e0e0;
    }
    .image-editor-header h3 {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-text);
    }
    .image-editor-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #888;
      padding: 2px;
    }
    .image-editor-close:hover { color: var(--color-primary); }
    .image-editor-body {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
      flex: 1;
    }
    .image-editor-preview {
      width: 100%;
      aspect-ratio: 16/10;
      background: var(--color-bg-alt);
      border-radius: var(--radius-sm);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--color-border);
    }
    .image-editor-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .image-editor-preview .placeholder-text {
      font-size: 12px;
      color: #aaa;
    }
    .image-editor-field label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #555;
      margin-bottom: 6px;
    }
    .image-editor-field input[type="text"] {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: var(--radius-sm);
      font-size: 13px;
      background: #fff;
      transition: border-color 0.15s;
    }
    .image-editor-field input[type="text"]:focus {
      outline: none;
      border-color: var(--color-primary);
    }
    .image-editor-or {
      text-align: center;
      font-size: 11px;
      color: #aaa;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .image-editor-upload-area {
      border: 2px dashed #ddd;
      border-radius: var(--radius-sm);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }
    .image-editor-upload-area:hover {
      border-color: var(--color-primary);
      background: #fff5f5;
    }
    .image-editor-upload-area .upload-icon {
      font-size: 24px;
      margin-bottom: 6px;
    }
    .image-editor-upload-area .upload-text {
      font-size: 12px;
      color: #888;
    }
    .image-editor-upload-area .upload-text strong {
      color: var(--color-primary);
    }
    .image-editor-apply-btn {
      width: 100%;
      padding: 10px;
      background: var(--color-primary);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s;
    }
    .image-editor-apply-btn:hover {
      background: var(--color-primary-dark);
    }
    .image-editor-apply-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- Top Bar -->
  <header class="builder-topbar">
    <h1>Campaign Component Builder</h1>
    <div class="topbar-right">
      <span class="component-count" id="componentCount">0 components selected</span>
    </div>
  </header>

  <!-- Settings Row (Phase 6 polish) -->
  <div class="builder-settings">
    <label for="pageTitle">Tryg DK Campaign Builder</label>
    <input type="text" id="pageTitle" placeholder="Kampagne" value="Kampagne">
    <label for="marketSelect">Market</label>
    <select id="marketSelect">
      <option value="da" selected>DK</option>
      <option value="no">NO</option>
      <option value="se">SE</option>
    </select>
    <button class="reset-btn" id="resetBtn">Reset All</button>
  </div>

  <!-- Three-Panel Layout -->
  <div class="builder-main">

    <!-- Left: Component Library -->
    <aside class="panel-library" id="libraryPanel">
      <div class="library-resize-handle" id="libraryResizeHandle"></div>
      <div class="library-scroll-inner" id="libraryScrollInner"></div>
    </aside>

    <!-- Centre: Canvas -->
    <main class="panel-canvas" id="panelCanvas">
      <div class="canvas-header">
        <span class="canvas-header-label">Selected Components</span>
        <button class="canvas-collapse-btn" id="canvasCollapseBtn" title="Collapse panel">&#8249;</button>
      </div>
      <span class="canvas-collapsed-label">Components</span>
      <div class="canvas-list" id="canvasList">
        <div class="canvas-empty" id="canvasEmpty">
          Select components from<br>the library to get started
        </div>
      </div>
      <div class="canvas-footer">
        <button class="export-btn" id="exportBtn" disabled>Edit &amp; Export</button>
      </div>
    </main>

    <!-- Right: Live Preview -->
    <section class="panel-preview" id="panelPreview">
      <div class="panel-resize-handle" id="resizeHandle"></div>
      <div class="preview-header">
        <span class="preview-label" id="previewLabel">Preview</span>
        <div class="preview-header-controls">
          <span class="preview-scale-indicator" id="scaleIndicator">100%</span>
          <div class="preview-toggles">
            <button class="active" data-width="375">Mobile</button>
            <button data-width="1280">Desktop</button>
          </div>
        </div>
      </div>
      <div class="preview-frame-wrapper" id="previewWrapper">
        <iframe id="previewFrame" frameborder="0"></iframe>
      </div>
    </section>

  </div>

  <!-- Edit & Export Modal -->
  <div class="edit-export-overlay" id="editExportOverlay">
    <div class="edit-export-modal">
      <div class="edit-export-toolbar">
        <h2>Edit Page Content</h2>
        <span class="toolbar-hint">Click text to edit ¬∑ Click icons or images to swap</span>
        <div class="edit-export-viewport-toggles" id="editViewportToggles">
          <button class="active" data-edit-width="375">Mobile</button>
          <button data-edit-width="1280">Desktop</button>
        </div>
        <div class="edit-export-actions">
          <button class="edit-export-download-btn" id="editExportDownloadBtn">Export to HTML</button>
          <button class="edit-export-close" id="editExportCloseBtn" title="Close">&times;</button>
        </div>
      </div>
      <div class="edit-export-body">
        <div class="edit-frame-wrapper" id="editFrameWrapper">
          <iframe id="editFrame"></iframe>
        </div>
        <div class="icon-picker-panel" id="iconPickerPanel">
          <div class="icon-picker-header">
            <h3>Choose Icon</h3>
            <button class="icon-picker-close" id="iconPickerClose">&times;</button>
          </div>
          <div class="icon-picker-grid" id="iconPickerGrid"></div>
        </div>
        <div class="image-editor-panel" id="imageEditorPanel">
          <div class="image-editor-header">
            <h3>Replace Image</h3>
            <button class="image-editor-close" id="imageEditorClose">&times;</button>
          </div>
          <div class="image-editor-body">
            <div class="image-editor-preview" id="imageEditorPreview">
              <span class="placeholder-text">Current image</span>
            </div>
            <div class="image-editor-field">
              <label for="imageUrlInput">Image URL</label>
              <input type="text" id="imageUrlInput" placeholder="https://example.com/photo.jpg">
            </div>
            <div class="image-editor-or">‚Äî or ‚Äî</div>
            <div class="image-editor-upload-area" id="imageUploadArea">
              <div class="upload-icon">üìÅ</div>
              <div class="upload-text"><strong>Click to upload</strong> or drag a file here</div>
              <input type="file" id="imageFileInput" accept="image/*" style="display:none">
            </div>
            <button class="image-editor-apply-btn" id="imageApplyBtn" disabled>Apply Image</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { COMPONENTS } from './components/index.js';

    /* =============================================================
       BRAND TOKENS (inline for export injection)
       ============================================================= */
    const BRAND_TOKENS = `
:root {
  --color-primary:  #ED1C24;
  --color-primary-dark: #D41920;
  --color-text:     #1A1A1A;
  --color-text-light: #666666;
  --color-bg:       #FFFFFF;
  --color-bg-alt:   #F5F5F5;
  --color-border:   #E0E0E0;
  --font-heading:   'Tryg Sans', Arial, sans-serif;
  --font-body:      Arial, sans-serif;
  --spacing-sm:     8px;
  --spacing-md:     16px;
  --spacing-lg:     32px;
  --spacing-xl:     64px;
  --radius:         24px;
  --radius-sm:      8px;
  --radius-card:    12px;
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font-body); color: var(--color-text); line-height: 1.6; }
img { max-width: 100%; height: auto; }
`;

    /* =============================================================
       APPLICATION STATE
       ============================================================= */
    let selectedComponents = [];
    let previewingId = null;
    let currentPreviewWidth = 375;
    let collapsedCategories = {};

    /* =============================================================
       DOM REFERENCES
       ============================================================= */
    const libraryPanel   = document.getElementById('libraryPanel');
    const canvasList     = document.getElementById('canvasList');
    const canvasEmpty    = document.getElementById('canvasEmpty');
    const exportBtn      = document.getElementById('exportBtn');
    const previewFrame   = document.getElementById('previewFrame');
    const componentCount = document.getElementById('componentCount');
    const pageTitleInput = document.getElementById('pageTitle');
    const marketSelect   = document.getElementById('marketSelect');
    const resetBtn       = document.getElementById('resetBtn');
    const panelPreview   = document.getElementById('panelPreview');
    const previewWrapper = document.getElementById('previewWrapper');
    const scaleIndicator = document.getElementById('scaleIndicator');
    const resizeHandle   = document.getElementById('resizeHandle');
    const panelCanvas    = document.getElementById('panelCanvas');
    const canvasCollapseBtn = document.getElementById('canvasCollapseBtn');

    /* =============================================================
       ANALYTICS SNIPPETS (Phase 5)
       ============================================================= */
    function analyticsSnippet() {
      return `<!-- Adobe Analytics -->
    <script src="https://cdn.tryg.com/analytics/AppMeasurement.js"><\/script>
    <script>
      var s = s_gi('trygprod');
      s.pageName = document.title;
      s.channel  = 'campaign';
      s.eVar1    = '${marketSelect.value}';
      s.eVar2    = 'campaign-landing';
    <\/script>`;
    }

    function tealiumSnippet() {
      return `<!-- Tealium iQ -->
    <script>
      var utag_data = {
        page_type:    'campaign-landing',
        market:       '${marketSelect.value}',
        product_type: '',
        campaign_id:  ''
      };
    <\/script>
    <script src="https://tags.tiqcdn.com/utag/tryg/${marketSelect.value}/prod/utag.js" async><\/script>`;
    }

    function utmHandling() {
      return `// UTM Parameter Handling
      var params       = new URLSearchParams(window.location.search);
      var utm_source   = params.get('utm_source')   || '';
      var utm_medium   = params.get('utm_medium')   || '';
      var utm_campaign = params.get('utm_campaign') || '';

      if (typeof s !== 'undefined') {
        s.eVar3 = utm_campaign;
        s.eVar4 = utm_source;
        s.eVar5 = utm_medium;
      }
      if (typeof utag_data !== 'undefined') {
        utag_data.campaign_id = utm_campaign;
      }

      // Track CTA clicks
      document.querySelectorAll('[data-track="cta"]').forEach(function(el) {
        el.addEventListener('click', function() {
          if (typeof s !== 'undefined' && s.tl) {
            s.tl(this, 'o', 'CTA Click: ' + (this.textContent || '').trim());
          }
        });
      });`;
    }

    /* =============================================================
       EXPORT LOGIC (Phase 4)
       ============================================================= */
    function assembleExport(components) {
      const pageTitle = pageTitleInput.value || 'Kampagne';
      const lang      = marketSelect.value;
      const css       = components.map(c => c.css).join('\n');
      const html      = components.map(c => c.html).join('\n');
      const js        = components.map(c => c.js).filter(Boolean).join('\n');

      return `<!DOCTYPE html>
<html lang="${lang}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- EDIT: Page title -->
  <title>${pageTitle}</title>
  <style>
    ${BRAND_TOKENS}
    ${css}
  </style>
  ${analyticsSnippet()}
  ${tealiumSnippet()}
</head>
<body>
  ${html}
  <script>
    ${utmHandling()}
    ${js}
  <\/script>
</body>
</html>`;
    }

    function downloadExport(htmlString) {
      const blob = new Blob([htmlString], { type: 'text/html' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = 'campaign-page.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /* =============================================================
       RENDER: Library Panel
       ============================================================= */
    function renderLibrary() {
      const categories = [...new Set(COMPONENTS.map(c => c.category))];
      const scrollInner = libraryPanel.querySelector('.library-scroll-inner');
      scrollInner.innerHTML = '<h2>Component Library</h2>';

      categories.forEach(cat => {
        const isCollapsed = collapsedCategories[cat] !== false;
        const group = document.createElement('div');
        group.className = 'library-category' + (isCollapsed ? ' collapsed' : '');

        const heading = document.createElement('h3');
        heading.innerHTML = `${cat} <span style="display:inline-flex;align-items:center;gap:6px"><span class="library-category-toggle">&#9660;</span><span style="font-size:10px;font-weight:400;letter-spacing:0;text-transform:none;color:#bbb">${isCollapsed ? 'Click to expand' : 'Click to collapse'}</span></span>`;
        heading.addEventListener('click', () => {
          const currentlyCollapsed = collapsedCategories[cat] !== false;
          collapsedCategories[cat] = !currentlyCollapsed;
          renderLibrary();
        });
        group.appendChild(heading);

        const itemsWrapper = document.createElement('div');
        itemsWrapper.className = 'library-category-items';

        COMPONENTS.filter(c => c.category === cat).forEach(comp => {
          const isSelected = selectedComponents.some(s => s.id === comp.id);
          const isPreviewing = previewingId === comp.id;
          const item = document.createElement('div');
          item.className = 'library-item' + (isPreviewing ? ' previewing' : '');
          item.innerHTML = `
            <input type="checkbox" data-id="${comp.id}" ${isSelected ? 'checked' : ''}>
            <div class="library-item-info">
              <div class="item-name">${comp.name} <span class="preview-icon">&#9673;</span></div>
              <div class="item-desc">${comp.description}</div>
            </div>`;

          // Checkbox: toggle selection
          item.querySelector('input').addEventListener('change', (e) => {
            if (e.target.checked) {
              addComponent(comp.id);
            } else {
              removeComponent(comp.id);
            }
          });

          // Click on info area: preview this component
          item.querySelector('.library-item-info').addEventListener('click', () => {
            if (previewingId === comp.id) {
              previewingId = null; // toggle off ‚Äî back to canvas preview
            } else {
              previewingId = comp.id;
            }
            renderLibrary();
            renderPreview();
          });

          itemsWrapper.appendChild(item);
        });

        group.appendChild(itemsWrapper);
        scrollInner.appendChild(group);
      });
    }

    /* =============================================================
       RENDER: Canvas (Drag-and-Drop)
       ============================================================= */
    let draggedId = null;

    function renderCanvas() {
      // Clear existing cards (keep empty state element)
      const cards = canvasList.querySelectorAll('.canvas-card');
      cards.forEach(c => c.remove());

      canvasEmpty.style.display = selectedComponents.length === 0 ? 'flex' : 'none';
      exportBtn.disabled = selectedComponents.length === 0;

      // Update count badge
      const count = selectedComponents.length;
      componentCount.textContent = `${count} component${count !== 1 ? 's' : ''} selected`;

      selectedComponents.forEach((comp, index) => {
        const card = document.createElement('div');
        card.className = 'canvas-card';
        card.setAttribute('draggable', 'true');
        card.dataset.id = comp.id;

        card.innerHTML = `
          <span class="drag-handle">&#9776;</span>
          <div class="card-info">
            <div class="card-name">${comp.name}</div>
            <div class="card-category">${comp.category}</div>
          </div>
          <button class="card-remove" title="Remove">&times;</button>`;

        // Remove button
        card.querySelector('.card-remove').addEventListener('click', () => {
          removeComponent(comp.id);
        });

        // Drag events
        card.addEventListener('dragstart', (e) => {
          draggedId = comp.id;
          card.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
        });

        card.addEventListener('dragend', () => {
          card.classList.remove('dragging');
          draggedId = null;
          // Remove drag-over from all
          canvasList.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        });

        card.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
          card.classList.add('drag-over');
        });

        card.addEventListener('dragleave', () => {
          card.classList.remove('drag-over');
        });

        card.addEventListener('drop', (e) => {
          e.preventDefault();
          card.classList.remove('drag-over');
          if (draggedId && draggedId !== comp.id) {
            reorderSelected(draggedId, comp.id);
            renderCanvas();
            renderPreview();
          }
        });

        canvasList.appendChild(card);
      });
    }

    /* =============================================================
       RENDER: Live Preview
       ============================================================= */
    const previewLabel = document.getElementById('previewLabel');

    function renderPreview() {
      // Single-component preview mode
      if (previewingId) {
        const comp = COMPONENTS.find(c => c.id === previewingId);
        if (comp) {
          previewLabel.innerHTML = `Preview <span class="preview-component-name">${comp.name}</span>`;
          const html = assembleExport([comp]);
          previewFrame.srcdoc = html;
          return;
        }
      }
      // Normal canvas preview
      previewLabel.textContent = 'Preview';
      if (selectedComponents.length === 0) {
        previewFrame.srcdoc = `<!DOCTYPE html>
          <html><body style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial;color:#bbb;font-size:14px;text-align:center;">
          <p>Select components to<br>see a live preview</p>
          </body></html>`;
        return;
      }
      const html = assembleExport(selectedComponents);
      previewFrame.srcdoc = html;
    }

    /* =============================================================
       STATE MANAGEMENT
       ============================================================= */
    function addComponent(id) {
      const c = COMPONENTS.find(c => c.id === id);
      if (c && !selectedComponents.some(s => s.id === id)) {
        selectedComponents.push(c);
        previewingId = null;
        renderCanvas();
        renderPreview();
        renderLibrary();
      }
    }

    function removeComponent(id) {
      selectedComponents = selectedComponents.filter(c => c.id !== id);
      previewingId = null;
      renderCanvas();
      renderPreview();
      renderLibrary();
    }

    function reorderSelected(draggedId, targetId) {
      const fromIndex = selectedComponents.findIndex(c => c.id === draggedId);
      const toIndex   = selectedComponents.findIndex(c => c.id === targetId);
      if (fromIndex === -1 || toIndex === -1) return;
      const [moved] = selectedComponents.splice(fromIndex, 1);
      selectedComponents.splice(toIndex, 0, moved);
    }

    /* =============================================================
       SCALE-TO-FIT PREVIEW
       ============================================================= */
    function updatePreviewScale() {
      const padding = 32; // 16px each side
      const availableWidth  = previewWrapper.clientWidth  - padding;
      const availableHeight = previewWrapper.clientHeight - padding;
      const scale = Math.min(1, availableWidth / currentPreviewWidth);

      previewFrame.style.width  = currentPreviewWidth + 'px';
      previewFrame.style.height = (availableHeight / scale) + 'px';
      previewFrame.style.transform = `scale(${scale})`;

      // Centre narrow frames (e.g. mobile 375px in a wide panel)
      if (scale >= 1 && currentPreviewWidth < availableWidth) {
        previewFrame.style.marginLeft = Math.round((availableWidth - currentPreviewWidth) / 2) + 'px';
      } else {
        previewFrame.style.marginLeft = '0';
      }

      scaleIndicator.textContent = Math.round(scale * 100) + '%';
    }

    /* =============================================================
       EVENT LISTENERS
       ============================================================= */
    /* =============================================================
       EDIT & EXPORT MODAL
       ============================================================= */
    const editOverlay     = document.getElementById('editExportOverlay');
    const editFrame       = document.getElementById('editFrame');
    const editCloseBtn    = document.getElementById('editExportCloseBtn');
    const editDownloadBtn = document.getElementById('editExportDownloadBtn');
    const iconPickerPanel = document.getElementById('iconPickerPanel');
    const iconPickerGrid  = document.getElementById('iconPickerGrid');
    const iconPickerClose = document.getElementById('iconPickerClose');

    const imageEditorPanel = document.getElementById('imageEditorPanel');
    const imageEditorClose = document.getElementById('imageEditorClose');
    const imageEditorPreview = document.getElementById('imageEditorPreview');
    const imageUrlInput    = document.getElementById('imageUrlInput');
    const imageUploadArea  = document.getElementById('imageUploadArea');
    const imageFileInput   = document.getElementById('imageFileInput');
    const imageApplyBtn    = document.getElementById('imageApplyBtn');

    let activeIconTarget = null; // index of the SVG being replaced
    let activeImageTarget = null; // index of the <img> being replaced
    let pendingImageSrc = null;  // URL or data-URL ready to apply

    // --- Curated icon library (inline SVGs) ---
    const ICON_LIBRARY = [
      { name: 'Checkmark',  svg: '<svg viewBox="0 0 24 24" fill="none"><path d="M20 6L9 17l-5-5" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Shield',     svg: '<svg viewBox="0 0 24 24" fill="none"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Star',       svg: '<svg viewBox="0 0 24 24" fill="none"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14l-5-4.87 6.91-1.01L12 2z" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Heart',      svg: '<svg viewBox="0 0 24 24" fill="none"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 000-7.78z" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Clock',      svg: '<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="var(--color-primary)" stroke-width="2"/><path d="M12 6v6l4 2" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Lock',       svg: '<svg viewBox="0 0 24 24" fill="none"><rect x="3" y="11" width="18" height="11" rx="2" stroke="var(--color-primary)" stroke-width="2"/><path d="M7 11V7a5 5 0 0110 0v4" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Car',        svg: '<svg viewBox="0 0 24 24" fill="none"><path d="M5 17h14M5 17a2 2 0 01-2-2v-3l2-5h10l2 5v3a2 2 0 01-2 2M5 17a2 2 0 002 2h0a2 2 0 002-2M15 17a2 2 0 002 2h0a2 2 0 002-2" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Home',       svg: '<svg viewBox="0 0 24 24" fill="none"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 22V12h6v10" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Globe',      svg: '<svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="var(--color-primary)" stroke-width="2"/><path d="M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10A15.3 15.3 0 0112 2z" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Phone',      svg: '<svg viewBox="0 0 24 24" fill="none"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6A19.79 19.79 0 012.12 4.18 2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'User',       svg: '<svg viewBox="0 0 24 24" fill="none"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="7" r="4" stroke="var(--color-primary)" stroke-width="2"/></svg>' },
      { name: 'Chart',      svg: '<svg viewBox="0 0 24 24" fill="none"><path d="M18 20V10M12 20V4M6 20v-6" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Bolt',       svg: '<svg viewBox="0 0 24 24" fill="none"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'ThumbsUp',   svg: '<svg viewBox="0 0 24 24" fill="none"><path d="M14 9V5a3 3 0 00-6 0v0l-2 8h3" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 13h6.764a2 2 0 011.789 1.106l1.447 2.894A2 2 0 0118.211 20H10a2 2 0 01-2-2v-3a2 2 0 012-2z" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Arrow Right',svg: '<svg viewBox="0 0 24 24" fill="none"><path d="M5 12h14M12 5l7 7-7 7" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Mail',       svg: '<svg viewBox="0 0 24 24" fill="none"><rect x="2" y="4" width="20" height="16" rx="2" stroke="var(--color-primary)" stroke-width="2"/><path d="M22 7l-10 6L2 7" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Umbrella',   svg: '<svg viewBox="0 0 24 24" fill="none"><path d="M18 19a3 3 0 01-6 0M12 2v1M12 3a9 9 0 019 9H3a9 9 0 019-9z" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>' },
      { name: 'Wallet',     svg: '<svg viewBox="0 0 24 24" fill="none"><rect x="2" y="6" width="20" height="14" rx="2" stroke="var(--color-primary)" stroke-width="2"/><path d="M2 10h20" stroke="var(--color-primary)" stroke-width="2"/><circle cx="17" cy="14" r="1" fill="var(--color-primary)"/></svg>' },
      { name: 'Percent',    svg: '<svg viewBox="0 0 24 24" fill="none"><circle cx="7" cy="7" r="3" stroke="var(--color-primary)" stroke-width="2"/><circle cx="17" cy="17" r="3" stroke="var(--color-primary)" stroke-width="2"/><path d="M20 4L4 20" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round"/></svg>' },
      { name: 'Family',     svg: '<svg viewBox="0 0 24 24" fill="none"><circle cx="9" cy="7" r="3" stroke="var(--color-primary)" stroke-width="2"/><circle cx="17" cy="7" r="2" stroke="var(--color-primary)" stroke-width="2"/><path d="M2 21v-2a4 4 0 014-4h6a4 4 0 014 4v2" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21v-2a3 3 0 00-2-2.83" stroke="var(--color-primary)" stroke-width="2" stroke-linecap="round"/></svg>' }
    ];

    // --- Build icon picker grid ---
    function buildIconPickerGrid() {
      iconPickerGrid.innerHTML = '';
      ICON_LIBRARY.forEach((icon, i) => {
        const btn = document.createElement('button');
        btn.title = icon.name;
        btn.innerHTML = icon.svg;
        btn.addEventListener('click', () => {
          if (activeIconTarget !== null) {
            editFrame.contentWindow.postMessage({ type: 'replaceIcon', index: activeIconTarget, svg: icon.svg }, '*');
            closeIconPicker();
          }
        });
        iconPickerGrid.appendChild(btn);
      });
    }
    buildIconPickerGrid();

    // --- Editing helper script injected into the preview iframe ---
    function getEditingScript() {
      return `
<style>
  [contenteditable="true"] {
    outline: 2px dashed transparent;
    transition: outline-color 0.15s, background 0.15s;
    cursor: text;
    border-radius: 3px;
  }
  [contenteditable="true"]:hover {
    outline-color: rgba(59,130,246,0.45);
    background: rgba(59,130,246,0.04);
  }
  [contenteditable="true"]:focus {
    outline-color: #3b82f6;
    outline-style: solid;
    background: rgba(59,130,246,0.06);
  }
  .icon-edit-overlay {
    position: absolute;
    inset: 0;
    cursor: pointer;
    border-radius: 50%;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
  }
  .icon-edit-overlay:hover {
    background: rgba(59,130,246,0.12);
  }
  .icon-edit-overlay:hover::after {
    content: '‚úé';
    font-size: 14px;
    color: #3b82f6;
    position: absolute;
    top: -4px;
    right: -4px;
    background: #fff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 1px 4px rgba(0,0,0,0.15);
  }
  [data-icon-wrapper] {
    position: relative;
    display: inline-block;
  }
  .img-edit-overlay {
    position: absolute;
    inset: 0;
    cursor: pointer;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
    background: transparent;
  }
  .img-edit-overlay:hover {
    background: rgba(59,130,246,0.18);
  }
  .img-edit-overlay .img-edit-badge {
    display: none;
    background: #3b82f6;
    color: #fff;
    font-size: 12px;
    font-weight: 600;
    padding: 6px 12px;
    border-radius: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    pointer-events: none;
  }
  .img-edit-overlay:hover .img-edit-badge {
    display: block;
  }
  [data-img-wrapper] {
    position: relative !important;
    display: block;
  }
  [data-img-editable] {
    cursor: pointer !important;
    transition: outline 0.15s, filter 0.15s;
    outline: 3px solid transparent;
    outline-offset: -3px;
  }
  [data-img-editable]:hover {
    outline-color: #3b82f6;
    filter: brightness(0.85);
  }
</style>
<script>
(function() {
  // Make text elements editable
  var textSelectors = 'h1, h2, h3, h4, h5, h6, p, li, span, a, button, figcaption, blockquote, dt, dd, label, strong, em, td, th';
  var editableEls = document.querySelectorAll(textSelectors);
  editableEls.forEach(function(el) {
    // Skip elements that only contain other block elements
    var hasDirectText = false;
    el.childNodes.forEach(function(n) {
      if (n.nodeType === 3 && n.textContent.trim().length > 0) hasDirectText = true;
    });
    // Also consider elements with only inline children as text-bearing
    if (!hasDirectText && el.children.length > 0) {
      var allInline = true;
      for (var i = 0; i < el.children.length; i++) {
        var tag = el.children[i].tagName;
        if (['DIV','SECTION','ARTICLE','UL','OL','TABLE','FORM','HEADER','FOOTER','NAV','ASIDE','MAIN','FIGURE'].indexOf(tag) !== -1) {
          allInline = false;
          break;
        }
      }
      if (allInline) hasDirectText = true;
    }
    if (hasDirectText) {
      el.setAttribute('contenteditable', 'true');
      el.setAttribute('spellcheck', 'false');
    }
  });

  // Wrap inline SVG icons with an edit overlay
  var svgs = document.querySelectorAll('svg');
  svgs.forEach(function(svg, idx) {
    // Skip very large SVGs (likely illustrations / placeholders, not icons)
    var w = parseInt(svg.getAttribute('width') || '0');
    var h = parseInt(svg.getAttribute('height') || '0');
    var vb = svg.getAttribute('viewBox');
    if (w > 80 || h > 80) return;
    // Also skip if it's inside a very large container (placeholder images)
    var parent = svg.parentElement;
    if (!parent) return;
    // Wrap parent for positioning
    parent.setAttribute('data-icon-wrapper', '');
    parent.style.position = 'relative';
    var overlay = document.createElement('div');
    overlay.className = 'icon-edit-overlay';
    overlay.dataset.iconIdx = idx;
    overlay.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      window.parent.postMessage({ type: 'openIconPicker', index: idx }, '*');
    });
    parent.appendChild(overlay);
  });

  // Listen for icon replacement messages from parent
  window.addEventListener('message', function(e) {
    if (e.data && e.data.type === 'replaceIcon') {
      var svgs = document.querySelectorAll('svg');
      var target = svgs[e.data.index];
      if (target) {
        var temp = document.createElement('div');
        temp.innerHTML = e.data.svg;
        var newSvg = temp.querySelector('svg');
        if (newSvg) {
          // Preserve original sizing attributes
          var ow = target.getAttribute('width');
          var oh = target.getAttribute('height');
          if (ow) newSvg.setAttribute('width', ow);
          if (oh) newSvg.setAttribute('height', oh);
          target.parentNode.replaceChild(newSvg, target);
        }
      }
    }
    if (e.data && e.data.type === 'replaceImage') {
      // Find the target by data-img-idx attribute
      var target = document.querySelector('[data-img-idx="' + e.data.index + '"]');
      if (target) {
        if (target.tagName === 'IMG') {
          // It's a real <img>, just swap src
          target.src = e.data.src;
        } else if (target.hasAttribute('data-img-placeholder')) {
          // It's a SVG placeholder container ‚Äî replace with a real <img>
          var newImg = document.createElement('img');
          newImg.src = e.data.src;
          newImg.alt = 'Custom image';
          newImg.style.width = '100%';
          newImg.style.height = '100%';
          newImg.style.objectFit = 'cover';
          newImg.style.borderRadius = 'inherit';
          newImg.setAttribute('data-img-editable', '');
          newImg.setAttribute('data-img-idx', e.data.index);
          // Clear placeholder contents and insert image
          target.innerHTML = '';
          target.removeAttribute('data-img-placeholder');
          target.appendChild(newImg);
          // Add click handler on the new img
          newImg.addEventListener('click', function(ev) {
            ev.preventDefault();
            ev.stopPropagation();
            window.parent.postMessage({ type: 'openImageEditor', index: e.data.index, currentSrc: newImg.src }, '*');
          });
        }
      }
    }
  });

  // Wrap <img> elements with click-to-edit
  var imgs = document.querySelectorAll('img');
  var imgIndex = 0;
  imgs.forEach(function(img) {
    var idx = imgIndex++;
    img.setAttribute('data-img-editable', '');
    img.setAttribute('data-img-idx', idx);
    img.style.cursor = 'pointer';

    // Also add an overlay for the visual badge
    var parent = img.parentElement;
    if (parent) {
      var cs = window.getComputedStyle(parent);
      if (cs.position === 'static' || cs.position === '') {
        parent.style.position = 'relative';
      }
      parent.setAttribute('data-img-wrapper', '');
      var overlay = document.createElement('div');
      overlay.className = 'img-edit-overlay';
      var badge = document.createElement('span');
      badge.className = 'img-edit-badge';
      badge.textContent = '\uD83D\uDDBC Replace image';
      overlay.appendChild(badge);
      overlay.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        window.parent.postMessage({ type: 'openImageEditor', index: idx, currentSrc: img.src }, '*');
      });
      parent.appendChild(overlay);
    }

    // Direct click handler on the image itself as fallback
    img.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      window.parent.postMessage({ type: 'openImageEditor', index: idx, currentSrc: img.src }, '*');
    });
  });

  // Also handle SVG-based image placeholders (large SVGs that look like placeholder images)
  var allSvgs = document.querySelectorAll('svg');
  allSvgs.forEach(function(svg) {
    var w = parseInt(svg.getAttribute('width') || '0');
    var h = parseInt(svg.getAttribute('height') || '0');
    // Only target large SVGs (>= 80px) that are likely image placeholders, not small icons
    if (w < 80 && h < 80) return;
    // Check if this SVG's container looks like an image placeholder
    var container = svg.parentElement;
    if (!container) return;
    // Assign an img index for this placeholder so image editor can target it
    var idx = imgIndex++;
    container.setAttribute('data-img-editable', '');
    container.setAttribute('data-img-idx', idx);
    container.setAttribute('data-img-placeholder', 'svg');
    container.style.cursor = 'pointer';
    container.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      window.parent.postMessage({ type: 'openImageEditor', index: idx, currentSrc: '', isPlaceholder: true }, '*');
    });
  });
})();
<\/script>`;
    }

    // --- Modal viewport toggle ---
    const editFrameWrapper = document.getElementById('editFrameWrapper');
    let editViewportWidth = 375;

    function updateEditFrameScale() {
      const padding = 32;
      const availableWidth  = editFrameWrapper.clientWidth  - padding;
      const availableHeight = editFrameWrapper.clientHeight - padding;
      const scale = Math.min(1, availableWidth / editViewportWidth);

      editFrame.style.width  = editViewportWidth + 'px';
      editFrame.style.height = (availableHeight / scale) + 'px';
      editFrame.style.transform = `scale(${scale})`;
    }

    document.querySelectorAll('#editViewportToggles button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#editViewportToggles button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        editViewportWidth = parseInt(btn.dataset.editWidth);
        updateEditFrameScale();
      });
    });

    // --- Open modal ---
    function openEditExportModal() {
      if (selectedComponents.length === 0) return;
      const rawHtml = assembleExport(selectedComponents);
      // Inject editing helpers right before </body>
      const editableHtml = rawHtml.replace('</body>', getEditingScript() + '\n</body>');
      editFrame.srcdoc = editableHtml;
      editOverlay.classList.add('open');
      document.body.style.overflow = 'hidden';
      // Delay scale calc until iframe is visible
      requestAnimationFrame(() => updateEditFrameScale());
    }

    // --- Close modal ---
    function closeEditExportModal() {
      editOverlay.classList.remove('open');
      document.body.style.overflow = '';
      closeIconPicker();
      closeImageEditor();
      editFrame.srcdoc = '';
    }

    // --- Icon picker ---
    function openIconPicker(index) {
      activeIconTarget = index;
      closeImageEditor(); // close image panel if open
      iconPickerPanel.classList.add('open');
    }
    function closeIconPicker() {
      activeIconTarget = null;
      iconPickerPanel.classList.remove('open');
    }

    // --- Image editor ---
    function openImageEditor(index, currentSrc) {
      activeImageTarget = index;
      pendingImageSrc = null;
      imageUrlInput.value = '';
      imageApplyBtn.disabled = true;
      closeIconPicker(); // close icon panel if open

      // Show current image in preview
      if (currentSrc) {
        imageEditorPreview.innerHTML = `<img src="${currentSrc}" alt="Current">`;
      } else {
        imageEditorPreview.innerHTML = '<span class="placeholder-text">No image</span>';
      }

      imageEditorPanel.classList.add('open');
    }
    function closeImageEditor() {
      activeImageTarget = null;
      pendingImageSrc = null;
      imageEditorPanel.classList.remove('open');
    }

    // URL input handler
    imageUrlInput.addEventListener('input', () => {
      const val = imageUrlInput.value.trim();
      if (val) {
        pendingImageSrc = val;
        imageApplyBtn.disabled = false;
        imageEditorPreview.innerHTML = `<img src="${val}" alt="Preview" onerror="this.style.display='none'">`;
      } else {
        pendingImageSrc = null;
        imageApplyBtn.disabled = true;
      }
    });

    // File upload ‚Äî click area
    imageUploadArea.addEventListener('click', () => imageFileInput.click());

    // File upload ‚Äî drag and drop
    imageUploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      imageUploadArea.style.borderColor = 'var(--color-primary)';
      imageUploadArea.style.background = '#fff5f5';
    });
    imageUploadArea.addEventListener('dragleave', () => {
      imageUploadArea.style.borderColor = '';
      imageUploadArea.style.background = '';
    });
    imageUploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      imageUploadArea.style.borderColor = '';
      imageUploadArea.style.background = '';
      const file = e.dataTransfer.files[0];
      if (file && file.type.startsWith('image/')) handleImageFile(file);
    });

    // File input change
    imageFileInput.addEventListener('change', () => {
      const file = imageFileInput.files[0];
      if (file) handleImageFile(file);
      imageFileInput.value = ''; // reset so same file can be re-selected
    });

    function handleImageFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        pendingImageSrc = e.target.result; // data URL
        imageApplyBtn.disabled = false;
        imageUrlInput.value = file.name;
        imageEditorPreview.innerHTML = `<img src="${pendingImageSrc}" alt="Preview">`;
      };
      reader.readAsDataURL(file);
    }

    // Apply button
    imageApplyBtn.addEventListener('click', () => {
      if (activeImageTarget !== null && pendingImageSrc) {
        editFrame.contentWindow.postMessage({ type: 'replaceImage', index: activeImageTarget, src: pendingImageSrc }, '*');
        closeImageEditor();
      }
    });

    imageEditorClose.addEventListener('click', closeImageEditor);

    // --- Clean HTML for final export ---
    function getCleanEditedHtml() {
      const doc = editFrame.contentDocument;
      if (!doc) return null;

      // Clone the document to avoid mutating the live preview
      const clone = doc.documentElement.cloneNode(true);

      // Remove all contenteditable attributes
      clone.querySelectorAll('[contenteditable]').forEach(el => {
        el.removeAttribute('contenteditable');
        el.removeAttribute('spellcheck');
      });

      // Remove icon edit overlays
      clone.querySelectorAll('.icon-edit-overlay').forEach(el => el.remove());

      // Remove image edit overlays
      clone.querySelectorAll('.img-edit-overlay').forEach(el => el.remove());

      // Remove data-icon-wrapper attributes
      clone.querySelectorAll('[data-icon-wrapper]').forEach(el => {
        el.removeAttribute('data-icon-wrapper');
      });

      // Remove data-img-wrapper attributes
      clone.querySelectorAll('[data-img-wrapper]').forEach(el => {
        el.removeAttribute('data-img-wrapper');
      });

      // Remove image editing attributes
      clone.querySelectorAll('[data-img-editable]').forEach(el => {
        el.removeAttribute('data-img-editable');
        el.removeAttribute('data-img-idx');
        el.removeAttribute('data-img-placeholder');
        el.style.removeProperty('cursor');
      });

      // Remove the injected editing <style> and <script> (last style and last script in body)
      const bodyEl = clone.querySelector('body');
      if (bodyEl) {
        // Remove editing style block (contains 'icon-edit-overlay')
        bodyEl.querySelectorAll('style').forEach(s => {
          if (s.textContent.includes('icon-edit-overlay')) s.remove();
        });
        // Remove editing script block (contains 'contenteditable')
        bodyEl.querySelectorAll('script').forEach(s => {
          if (s.textContent.includes('icon-edit-overlay') || s.textContent.includes('contenteditable')) s.remove();
        });
      }

      return '<!DOCTYPE html>\n<html' + clone.outerHTML.slice(clone.outerHTML.indexOf('<html') + 5);
    }

    // --- Event listeners ---
    // Export button now opens modal
    exportBtn.addEventListener('click', () => {
      openEditExportModal();
    });

    // Close modal
    editCloseBtn.addEventListener('click', closeEditExportModal);
    editOverlay.addEventListener('click', (e) => {
      if (e.target === editOverlay) closeEditExportModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && editOverlay.classList.contains('open')) closeEditExportModal();
    });

    // Download final HTML from modal
    editDownloadBtn.addEventListener('click', () => {
      const cleaned = getCleanEditedHtml();
      if (cleaned) downloadExport(cleaned);
    });

    // Icon picker close
    iconPickerClose.addEventListener('click', closeIconPicker);

    // Listen for messages from the edit iframe (icon click, image click)
    window.addEventListener('message', (e) => {
      if (e.data && e.data.type === 'openIconPicker') {
        openIconPicker(e.data.index);
      }
      if (e.data && e.data.type === 'openImageEditor') {
        openImageEditor(e.data.index, e.data.currentSrc);
      }
    });

    // Preview viewport toggle (scale-to-fit)
    document.querySelectorAll('.preview-toggles button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.preview-toggles button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentPreviewWidth = parseInt(btn.dataset.width);
        updatePreviewScale();
      });
    });

    // Panel resize ‚Äî drag left edge of preview panel
    let isResizing = false;
    let resizeStartX = 0;
    let resizeStartWidth = 0;

    resizeHandle.addEventListener('mousedown', (e) => {
      isResizing = true;
      resizeStartX = e.clientX;
      resizeStartWidth = panelPreview.offsetWidth;
      resizeHandle.classList.add('is-dragging');
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
      e.preventDefault();
    });

    // Panel resize ‚Äî drag right edge of library panel
    let isLibResizing = false;
    let libResizeStartX = 0;
    let libResizeStartWidth = 0;

    libraryPanel.addEventListener('mousedown', (e) => {
      if (!e.target.classList.contains('library-resize-handle')) return;
      isLibResizing = true;
      libResizeStartX = e.clientX;
      libResizeStartWidth = libraryPanel.offsetWidth;
      e.target.classList.add('is-dragging');
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (isResizing) {
        const dx = resizeStartX - e.clientX; // drag left = wider panel
        const minWidth = 280;
        const maxWidth = window.innerWidth - libraryPanel.offsetWidth - 180;
        const newWidth = Math.min(maxWidth, Math.max(minWidth, resizeStartWidth + dx));
        panelPreview.style.width = newWidth + 'px';
        updatePreviewScale();
      }
      if (isLibResizing) {
        const dx = e.clientX - libResizeStartX; // drag right = wider panel
        const minWidth = 180;
        const maxWidth = window.innerWidth - panelPreview.offsetWidth - 180;
        const newWidth = Math.min(maxWidth, Math.max(minWidth, libResizeStartWidth + dx));
        libraryPanel.style.width = newWidth + 'px';
        updatePreviewScale();
      }
    });

    document.addEventListener('mouseup', () => {
      if (isResizing) {
        isResizing = false;
        resizeHandle.classList.remove('is-dragging');
      }
      if (isLibResizing) {
        isLibResizing = false;
        const handle = libraryPanel.querySelector('.library-resize-handle');
        if (handle) handle.classList.remove('is-dragging');
      }
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    });

    // Recompute scale on window resize
    window.addEventListener('resize', () => {
      updatePreviewScale();
      if (editOverlay.classList.contains('open')) updateEditFrameScale();
    });

    // Canvas collapse/expand
    canvasCollapseBtn.addEventListener('click', () => {
      panelCanvas.classList.toggle('collapsed');
      updatePreviewScale();
    });

    // Page title and market selector trigger preview refresh
    pageTitleInput.addEventListener('input', () => renderPreview());
    marketSelect.addEventListener('change', () => renderPreview());

    // Reset button
    resetBtn.addEventListener('click', () => {
      selectedComponents = [];
      previewingId = null;
      pageTitleInput.value = 'Kampagne';
      marketSelect.value = 'da';
      renderLibrary();
      renderCanvas();
      renderPreview();
    });

    /* =============================================================
       INIT
       ============================================================= */
    renderLibrary();
    renderCanvas();
    renderPreview();
    updatePreviewScale();

  </script>
</body>
</html>
